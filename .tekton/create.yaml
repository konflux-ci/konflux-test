apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: hacbs-test-on-pull-request
  annotations:
    pipelinesascode.tekton.dev/max-keep-runs: "3"
    pipelinesascode.tekton.dev/on-event: "[pull_request]"
    pipelinesascode.tekton.dev/on-target-branch: "[main]"
    pipelinesascode.tekton.dev/task: "[buildah]"
spec:
  params:
    - name: output-image
      value: quay.io/redhat-appstudio/clair-test-build:to_test
    - name: builder-image
      value: registry.access.redhat.com/ubi9/buildah:9.0.0-19@sha256:c8b1d312815452964885680fc5bc8d99b3bfe9b6961228c71a09c72ca8e915eb
    - name: dockerfile
      value: /clair-in-ci/Dockerfile
  pipelineSpec:
    params:
      - name: output-image
      - name: builder-image
      - name: dockerfile
    workspaces:
      - name: workspace
    tasks:
      - name: git-clone
        workspaces:
          - name: clone-workspace
            workspace: workspace
        taskSpec:
          workspaces:
            - name: clone-workspace
          steps:
            - name: clone-hacbs-test
              image: registry.access.redhat.com/ubi9/python-39
              workingDir: $(workspaces.clone-workspace.path)
              script: |
                #!/usr/bin/env bash
                git clone https://github.com/redhat-appstudio/hacbs-test.git
#      - name: build-image
#        workspaces:
#          - name: source
#            workspace: workspace
#        params:
#          - name: IMAGE
#            value: quay.io/redhat-appstudio/clair-test-build:to_test
#          - name: BUILDER_IMAGE
#            value: $(params.builder-image)
#          - name: DOCKERFILE
#            value: $(workspaces.source.path)/hacbs-test$(params.dockerfile)
#        runAfter:
#          - git-clone
#        taskRef:
#          name: buildah
#          kind: ClusterTask
      - name: trigger-tests-and-push
        runAfter:
          - git-clone
        taskSpec:
          steps:
            - name: tigger-workflow
              image: registry.access.redhat.com/ubi9/python-39
              script: |
                #!/usr/bin/env bash
                curl -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{secrets.HACBS_TEST_GITHUB_TOKEN}}" --request POST --data '{"event_type":"trigger_workflow"}' https://api.github.com/repos/jsztuka/hacbs-test/dispatches
  workspaces:
    - name: workspace
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
